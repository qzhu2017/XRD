{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% macro structure() %}
  <div id="appdiv"></div>
  <div class="btn-group pull-left">
    <button type="button" class="btn btn-link dropdown-toggle btn-sm" data-toggle="dropdown">
    Unit cell <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
    <li><a onclick="repeatCell(1, 1, 1);">1x1x1</a></li>
    <li><a onclick="repeatCell(2, 2, 2);">2x2x2</a></li>
    <li><a onclick="repeatCell(3, 3, 3);">3x3x3</a></li>
    </ul>
  </div>
{% endmacro %}

{% block app_content %}
  <!-- BEGIN JSmol IMPORTS -->
  <script src="{{ url_for('static', filename='jsmol/JSmol.min.js') }}"></script>
  <script>
    jmol_isReady = function(applet) {
      Jmol._getElement(applet, "appletdiv").style.border="1px solid lightgray";
      Jmol.script(jmolApplet0, "set displaycellparameters false;")
      Jmol.script(jmolApplet0,
      "load struct/cif { 1 1 1 };");
    }
  </script>
  <script src="{{ url_for('static', filename='jsmol.js') }}"></script>
  <!-- END JSmol IMPORTS -->

  <h1>Virtual X-ray Diffraction</h1>
  <div class="row">
    <form class="form" method="post" enctype="multipart/form-data" role="form">
      {{ form.hidden_tag() }}
      {{ wtf.form_errors(form, hiddens="only") }}
      
      <div class="col-lg-3">
        {{ wtf.form_field(form.upload) }}
        {{ wtf.form_field(form.wavelength) }}
        {{ wtf.form_field(form.res) }}
        <table>
          <tr>
            <td>
              {{ wtf.form_field(form.min2theta) }}
            </td>
            <td>
              {{ wtf.form_field(form.max2theta) }}
            </td>
          </tr>        
        </table>              
        {{ wtf.form_field(form.submit, button_map={'submit': 'primary'}) }}
      </div>
      <div class="col-lg-3">          
        <div class="form-group ">
          <label class="control-label" for="method">{{ form.method.label }}</label>
          {{ form.method(class="form-control") }}
          <p class="help-block">{{ form.method.description }}</p>
        </div>
        <div class="form-group  required">
          <label class="control-label" id="fwhm-label" for="fwhm">{{ form.fwhm.label }}</label>
          {{ form.fwhm(class="form-control") }}
          <p class="help-block" id="fwhm-help">{{ form.fwhm.description }}</p>
        </div>
        <table>
          <tr>
            <td>
              <div class="form-group  required">
                <label class="control-label" id="u-label" for="u" style="display: none;">{{ form.u.label }}</label>
                {{ form.u(class="form-control", style="display: none;") }}
                <p class="help-block" id="u-help" style="display: none;">{{ form.u.description }}</p>
              </div>
            </td>
            <td>
              <div class="form-group  required">
                <label class="control-label" id="v-label" for="v" style="display: none;">{{ form.v.label }}</label>
                {{ form.v(class="form-control", style="display: none;") }}
                <p class="help-block" id="v-help" style="display: none;">{{ form.v.description }}</p>
              </div>
            </td>
          </tr>
        </table>
        <table>
          <tr>
            <td>
              <div class="form-group  required">
                <label class="control-label" id="w-label" for="w" style="display: none;">{{ form.w.label }}</label>
                {{ form.w(class="form-control", style="display: none;") }}
                <p class="help-block" id="w-help" style="display: none;">{{ form.w.description }}</p>
              </div>
            </td>
            <td>
              <div class="form-group  required">
                <label class="control-label" id="a-label" for="a" style="display: none;">{{ form.a.label }}</label>
                  {{ form.a(class="form-control", style="display: none;") }}
                  <p class="help-block" id="a-help" style="display: none;">{{ form.a.description }}</p>
              </div>
            </td>
          </tr>
        </table>
        <table>
          <tr>
            <td>
              <div class="form-group  required">
                <label class="control-label" id="eta_h-label" for="eta_h" style="display: none;">{{ form.eta_h.label }}</label>
                {{ form.eta_h(class="form-control", style="display: none;") }}
                <p class="help-block" id="eta_h-help" style="display: none;">{{ form.eta_h.description }}</p>
              </div>
            </td>
            <td>
              <div class="form-group  required">
                <label class="control-label" id="eta_l-label" for="eta_l" style="display: none;">{{ form.eta_l.label }}</label>
                {{ form.eta_l(class="form-control", style="display: none;") }}
                <p class="help-block" id="eta_l-help" style="display: none;">{{ form.eta_l.description }}</p>
              </div>
            </td>
          </tr>
        </table>
      </div>
      <div class="col-lg-6">
        {% if jsmol %}
          {{ structure() }}
        {% endif %}
      </div>
    </form>
  </div>
  <div class="row">
    <div class="col-lg-12">
      {% if plot %}
        {{ plot|safe }}
      {% endif %}
    </div>
  </div>

  <script>
    $(document).ready(function() {
      $('#method').change(function() {
        if ($(this).val() === 'gaussian' || $(this).val() === 'lorentzian') {
          $('#fwhm-label').show();
          $('#fwhm').show();
          $('#fwhm-help').show();
          $('#u-label').hide();
          $('#u').hide();
          $('#u-help').hide();
          $('#v-label').hide();
          $('#v').hide();
          $('#v-help').hide();
          $('#w-label').hide();
          $('#w').hide();
          $('#w-help').hide();
          $('#a-label').hide();
          $('#a').hide();
          $('#a-help').hide();
          $('#eta_h-label').hide();
          $('#eta_h').hide();
          $('#eta_h-help').hide();
          $('#eta_l-label').hide();
          $('#eta_l').hide();
          $('#eta_l-help').hide();
        }
        if ($(this).val() === 'pseudo_voigt') {
          $('#fwhm-label').hide();
          $('#fwhm').hide();
          $('#fwhm-help').hide();
          $('#u-label').show();
          $('#u').show();
          $('#u-help').show();
          $('#v-label').show();
          $('#v').show();
          $('#v-help').show();
          $('#w-label').show();
          $('#w').show();
          $('#w-help').show();
          $('#a-label').show();
          $('#a').show();
          $('#a-help').show();
          $('#eta_h-label').show();
          $('#eta_h').show();
          $('#eta_h-help').show();
          $('#eta_l-label').show();
          $('#eta_l').show();
          $('#eta_l-help').show();
        }
      }).change(); // will trigger when DOM is ready
    })
  </script>
{% endblock %}
